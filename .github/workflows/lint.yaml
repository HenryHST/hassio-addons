---
name: Lint

on:
  push:
    branches:
      - main
      - master
  pull_request:
  workflow_dispatch:

jobs:
  yamllint:
    name: YAML Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Run yamllint
        uses: ibiqlik/action-yamllint@v3
        with:
          config_file: .yamllint
          file_or_dir: .
          strict: false

  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: ./
          severity: warning
          ignore_paths: node_modules
        env:
          SHELLCHECK_OPTS: -e SC1008

  hadolint:
    name: Hadolint (Dockerfile)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Run Hadolint on netboot_xyz
        uses: hadolint/hadolint-action@v3.3.0
        with:
          dockerfile: netboot_xyz/Dockerfile
          failure-threshold: warning

      - name: Run Hadolint on nut
        uses: hadolint/hadolint-action@v3.3.0
        with:
          dockerfile: nut/Dockerfile
          failure-threshold: warning

  validate-config:
    name: Validate addon configs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Validate netboot_xyz config
        run: |
          echo "Validating netboot_xyz/config.yaml..."
          yq eval '.' netboot_xyz/config.yaml > /dev/null

          # Check required fields
          yq eval '.name' netboot_xyz/config.yaml
          yq eval '.version' netboot_xyz/config.yaml
          yq eval '.slug' netboot_xyz/config.yaml
          yq eval '.arch' netboot_xyz/config.yaml

          echo "✓ netboot_xyz config is valid"

      - name: Validate nut config
        run: |
          echo "Validating nut/config.yaml..."
          yq eval '.' nut/config.yaml > /dev/null

          # Check required fields
          yq eval '.name' nut/config.yaml
          yq eval '.version' nut/config.yaml
          yq eval '.slug' nut/config.yaml
          yq eval '.arch' nut/config.yaml

          echo "✓ nut config is valid"
